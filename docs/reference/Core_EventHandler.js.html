<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Core/EventHandler.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="App.html">App</a></li><li><a href="Context_Context.html">Context</a></li><li><a href="ContextProps_ContextProps.html">ContextProps</a></li><li><a href="DeskproAPIClient_DeskproAPIClient.html">DeskproAPIClient</a></li><li><a href="InstanceProps_InstanceProps.html">InstanceProps</a></li><li><a href="OauthConnection_OauthConnection.html">OauthConnection</a></li><li><a href="OauthFacade_OauthFacade.html">OauthFacade</a></li><li><a href="OauthToken_OauthToken.html">OauthToken</a></li><li><a href="PropertyBag.html">PropertyBag</a><ul class='methods'><li data-type='method'><a href="PropertyBag.html#getProperty">getProperty</a></li></ul></li><li><a href="StateApiFacade.html">StateApiFacade</a><ul class='methods'><li data-type='method'><a href="StateApiFacade.html#getState">getState</a></li><li data-type='method'><a href="StateApiFacade.html#setEntityState">setEntityState</a></li></ul></li><li><a href="UIFacade_UIFacade.html">UIFacade</a></li><li><a href="WidgetRequest_WidgetRequest.html">WidgetRequest</a></li><li><a href="WidgetResponse_WidgetResponse.html">WidgetResponse</a></li><li><a href="WindowProxy.html">WindowProxy</a></li></ul><h3>Global</h3><ul><li><a href="global.html#buildMap">buildMap</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#createApp">createApp</a></li><li><a href="global.html#createAppFromProps">createAppFromProps</a></li><li><a href="global.html#createContext">createContext</a></li><li><a href="global.html#createDispatchOutgoingResponseEvent">createDispatchOutgoingResponseEvent</a></li><li><a href="global.html#createOauthAPIClient">createOauthAPIClient</a></li><li><a href="global.html#createOutgoingRequestMessage">createOutgoingRequestMessage</a></li><li><a href="global.html#createOutgoingResponseMessage">createOutgoingResponseMessage</a></li><li><a href="global.html#createResizer">createResizer</a></li><li><a href="global.html#createStateAPIClient">createStateAPIClient</a></li><li><a href="global.html#dispatch">dispatch</a></li><li><a href="global.html#dispatchIncomingEvent">dispatchIncomingEvent</a></li><li><a href="global.html#emitAsync">emitAsync</a></li><li><a href="global.html#getXcomponentOptions">getXcomponentOptions</a></li><li><a href="global.html#matchEvent">matchEvent</a></li><li><a href="global.html#matchProps">matchProps</a></li><li><a href="global.html#parseIncomingRequestMessage">parseIncomingRequestMessage</a></li><li><a href="global.html#parseIncomingResponseMessage">parseIncomingResponseMessage</a></li><li><a href="global.html#parseInitParamsFromLocation">parseInitParamsFromLocation</a></li><li><a href="global.html#parseQueryString">parseQueryString</a></li><li><a href="global.html#toParamName">toParamName</a></li><li><a href="global.html#toPropName">toPropName</a></li><li><a href="global.html#tryAndCreate">tryAndCreate</a></li><li><a href="global.html#validate">validate</a></li><li><a href="global.html#validateNameValuePairsList">validateNameValuePairsList</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Core/EventHandler.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { MessageBus, IncomingEventDispatcher, OutgoingEventDispatcher } from './EventDispatcher';
import { windowProxy } from './Window';
import { WidgetRequest, WidgetResponse, parseIncomingMessage, createOutgoingResponseMessage, createOutgoingRequestMessage } from './Message';
import { on as postRobotOn } from '../../../post-robot';
import { INVOCATION_REQUESTRESPONSE, INVOCATION_FIREANDFORGET } from './Event'

/**
 * @param {String} eventName
 * @param {Object} eventProps
 * @param rawMessage
 */
const dispatchIncomingEvent = (eventName, eventProps, rawMessage) => {
  // this should not be here good here
  const { onDpMessage: postRobotSend } = windowProxy.xchild.props;

  const message = parseIncomingMessage(rawMessage);
  if (message instanceof WidgetRequest &amp;&amp; eventProps.invocationType === INVOCATION_REQUESTRESPONSE) {
    MessageBus.once(message.correlationId, response => {
      const payload = response instanceof WidgetResponse ? response.toJS() : response;
      postRobotSend(eventName, payload);
    });
    MessageBus.emit(eventName, message);
  }

  if (message instanceof WidgetRequest &amp;&amp; eventProps.invocationType === INVOCATION_FIREANDFORGET) {
    MessageBus.emit(eventName, message);
  }

  if (message instanceof WidgetResponse &amp;&amp; eventProps.invocationType === INVOCATION_REQUESTRESPONSE) {
    MessageBus.emit(message.correlationId, message);
  }
};

/**
 * TODO: this should handle requests and response, not only requests
 * @param request
 */
const createDispatchOutgoingResponseEvent = request => (error, data) => {
  const responsePayload = error ? error: data;
  const createErrorResponse = !!error;
  const response = createOutgoingResponseMessage(request, responsePayload, createErrorResponse);

  MessageBus.emit(response.correlationId, response);
};

const registerIncomingEventHandler = (eventName, eventProps, eventHandler) => {
  MessageBus.on(eventName, eventHandler);
  postRobotOn(eventName, event => dispatchIncomingEvent(eventName, eventProps, event.data));
};

export const handleIncomingEvent = (eventName, eventProps) =>
{
  let eventHandler;

  if (eventProps.invocationType === INVOCATION_REQUESTRESPONSE) {
    eventHandler = request =>
    {
      const cb = createDispatchOutgoingResponseEvent(request);
      IncomingEventDispatcher.emit(eventName, cb, request.body);
    }
  } else if (eventProps.invocationType === INVOCATION_FIREANDFORGET) {
    eventHandler = request => IncomingEventDispatcher.emit(eventName, request.body);
  }

  if (eventHandler) {
    registerIncomingEventHandler(eventName, eventProps, eventHandler);
  }

};

// outgoing events

const registerOutgoingEventHandler = (eventName, eventProps, eventHandler) => {
  OutgoingEventDispatcher.on(eventName, eventHandler);
  postRobotOn(eventName, event => dispatchIncomingEvent(eventName, eventProps, event.data));
};

export const handleOutgoingEvent = (eventName, eventProps) =>
{
  let eventHandler;

  if (eventProps.invocationType === INVOCATION_REQUESTRESPONSE) {
    eventHandler = (resolve, reject, data) => {
      // here we are sure windowProxy.xchild has been initialized, but this knowledge only makes this function brittle
      const { widgetId, onDpMessage: postRobotSend } = windowProxy.xchild.props;
      const request = createOutgoingRequestMessage(widgetId, data);

      // register a response listener
      MessageBus.once(request.correlationId, response => (response.status == 'success' ? resolve(response.body) : reject(response.body)) );
      postRobotSend(eventName, request.toJS());
    }
  } else if (eventProps.invocationType === INVOCATION_FIREANDFORGET) {
    eventHandler = (resolve, reject, data) => {
      // here we are sure windowProxy.xchild has been initialized, but this knowledge only makes this function brittle
      const { widgetId, onDpMessage: postRobotSend } = windowProxy.xchild.props;

      const request = createOutgoingRequestMessage(widgetId, data);
      postRobotSend(eventName, request.toJS());
      resolve(data);
    }
  }

  if (eventHandler) {
    registerOutgoingEventHandler(eventName, eventProps, eventHandler);
  }

};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
