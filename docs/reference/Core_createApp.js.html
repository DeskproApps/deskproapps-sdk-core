<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Core/createApp.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="App.html">App</a></li><li><a href="Context_Context.html">Context</a></li><li><a href="ContextProps_ContextProps.html">ContextProps</a></li><li><a href="DeskproAPIClient_DeskproAPIClient.html">DeskproAPIClient</a></li><li><a href="InstanceProps_InstanceProps.html">InstanceProps</a></li><li><a href="OauthConnection_OauthConnection.html">OauthConnection</a></li><li><a href="OauthFacade_OauthFacade.html">OauthFacade</a></li><li><a href="OauthToken_OauthToken.html">OauthToken</a></li><li><a href="PropertyBag.html">PropertyBag</a><ul class='methods'><li data-type='method'><a href="PropertyBag.html#getProperty">getProperty</a></li></ul></li><li><a href="StateApiFacade.html">StateApiFacade</a><ul class='methods'><li data-type='method'><a href="StateApiFacade.html#getState">getState</a></li><li data-type='method'><a href="StateApiFacade.html#setEntityState">setEntityState</a></li></ul></li><li><a href="UIFacade_UIFacade.html">UIFacade</a></li><li><a href="WidgetRequest_WidgetRequest.html">WidgetRequest</a></li><li><a href="WidgetResponse_WidgetResponse.html">WidgetResponse</a></li><li><a href="WindowProxy.html">WindowProxy</a></li></ul><h3>Global</h3><ul><li><a href="global.html#buildMap">buildMap</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#createApp">createApp</a></li><li><a href="global.html#createAppFromProps">createAppFromProps</a></li><li><a href="global.html#createContext">createContext</a></li><li><a href="global.html#createDispatchOutgoingResponseEvent">createDispatchOutgoingResponseEvent</a></li><li><a href="global.html#createOauthAPIClient">createOauthAPIClient</a></li><li><a href="global.html#createOutgoingRequestMessage">createOutgoingRequestMessage</a></li><li><a href="global.html#createOutgoingResponseMessage">createOutgoingResponseMessage</a></li><li><a href="global.html#createResizer">createResizer</a></li><li><a href="global.html#createStateAPIClient">createStateAPIClient</a></li><li><a href="global.html#dispatch">dispatch</a></li><li><a href="global.html#dispatchIncomingEvent">dispatchIncomingEvent</a></li><li><a href="global.html#emitAsync">emitAsync</a></li><li><a href="global.html#getXcomponentOptions">getXcomponentOptions</a></li><li><a href="global.html#matchEvent">matchEvent</a></li><li><a href="global.html#matchProps">matchProps</a></li><li><a href="global.html#parseIncomingRequestMessage">parseIncomingRequestMessage</a></li><li><a href="global.html#parseIncomingResponseMessage">parseIncomingResponseMessage</a></li><li><a href="global.html#parseInitParamsFromLocation">parseInitParamsFromLocation</a></li><li><a href="global.html#parseQueryString">parseQueryString</a></li><li><a href="global.html#toParamName">toParamName</a></li><li><a href="global.html#toPropName">toPropName</a></li><li><a href="global.html#tryAndCreate">tryAndCreate</a></li><li><a href="global.html#validate">validate</a></li><li><a href="global.html#validateNameValuePairsList">validateNameValuePairsList</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Core/createApp.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { isBrowser } from './utils';

import { windowProxy } from './Window';

import { InternalEventDispatcher, IncomingEventDispatcher, OutgoingEventDispatcher } from './EventDispatcher';

import { registerEventHandlers as registerStateEventHandlers } from '../State';
import { registerEventHandlers as registerSecurityEventHandlers } from '../Security';
import { registerEventHandlers as registerAppEventHandlers } from './AppEventHandlers';
import { registerEventHandlers as registerContextEventHandlers } from './ContextEventHandlers';
import { registerEventHandlers as registerWebAPIEventHandlers } from '../WebAPI';
import { registerEventHandlers as registerTicketEventHandlers } from '../Context/TicketEventHandlers';
import { registerEventHandlers as registerDeskproWindowEventHandlers } from '../DeskproWindow';

import App from './App';

import { create } from '../../../xcomponent';
import { InstanceProps, ContextProps } from './AppProps';

//register event listeners
[
  registerSecurityEventHandlers,
  registerStateEventHandlers,
  registerAppEventHandlers,
  registerContextEventHandlers,
  registerWebAPIEventHandlers,
  registerDeskproWindowEventHandlers,
  registerTicketEventHandlers
].forEach(registrar => registrar(IncomingEventDispatcher, OutgoingEventDispatcher));

/**
 * @param {InitProps} initParams
 * @return {{dimensions: {width: string, height: string}, props: {widgetId: {type: string, required: boolean}, appId: {type: string, required: boolean}, appTitle: {type: string, required: boolean}, appPackageName: {type: string, required: boolean}, instanceId: {type: string, required: boolean}, onDpMessage: {type: string, required: boolean}}, scrolling: boolean, autoResize: boolean, tag: *, url: string}}
 */
const getXcomponentOptions = initParams => {

  return {
    scrolling: false,
    tag: initParams.dpXconfTag, //needs to match xcomponent config on the parent
    url: 'http://localhost', // dummy entry to bypass validation

    dimensions: { width: '100%', height: '100%' },

    props: {

      // WIDGET PROPERTIES

      widgetId: {
        type: 'string',
        required: true
      },

      onDpMessage: {
        type: 'function',
        required: true
      },

      instanceProps: {
        type:     'object',
        required: true
      },

      contextProps: {
        type:     'object',
        required: true
      }
    }
  };
};

/**
 * Creates an application using the keys defined on the props object
 *
 * @param {Object} instanceProps
 * @param {Object} contextProps
 * @return {App}
 */
export const createAppFromProps = ({instanceProps, contextProps}) =>
{
  const appProps = {
    incomingDispatcher: IncomingEventDispatcher,
    outgoingDispatcher: OutgoingEventDispatcher,
    internalDispatcher: InternalEventDispatcher,
    instanceProps: new InstanceProps(instanceProps),
    contextProps: new ContextProps(contextProps),
    windowProxy
  };

  return new App(appProps);
};

/**
 * @param {function} cb
 */
const createApp = (cb) => {
  const xcomponentOptions = getXcomponentOptions(windowProxy.initParams);
  const xcomponent = create(xcomponentOptions);

  if (xcomponent.isChild()) {
      xcomponent.child().init().then(xchild => {

        const {instanceProps, contextProps} = xchild.props;
        const app = createAppFromProps({instanceProps, contextProps});

        // register the app with the resize listener
        windowProxy.addEventListener('bodyResize', () => app.ui.resetSize());
        windowProxy.addEventListener('load', () => cb(app));
      }).catch();
  } else if (isBrowser()) { // TODO this is clearly not going to work so the scenario where the app can run without xcomponent needs rethinking
      windowProxy.addEventListener('load', () => cb(app));
  }
};

export default createApp;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Tue Aug 08 2017 13:05:50 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
